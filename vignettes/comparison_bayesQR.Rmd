---
title: "tauBayesW"
author: "tauBayesW Package"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Comparison: bayesQR vs tauBayesW Methods}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  fig.width = 7,
  fig.height = 5
)
```

# Introduction

The tauBayesW package implements three MCMC approaches and a multiple-output EM algorithm:

- **Asymmetric Laplace Distribution**: Traditional approach using ALD likelihood
- **Score**: Score-based likelihood approach for complex survey designs
- **Approximate**: Fast approximate method for large datasets
- ** Expected Maximization Algorithm**: For the multivariate case 



Also the vignette the performance of **bayesQR** with the three MCMC methods implemented in **tauBayesW** using a simulated dataset and the classic Prostate cancer dataset included on the bayesQR package. We'll estimate the 75th quantile and compare the coefficient estimates across all methods.



# tauBayesW Usage Examples

Let's begin showing how to use tauBayesW methods:

## Creating Priors

```{r prior-examples, eval=FALSE}
# Create a prior for p=5 coefficients
my_prior <- tauBayesW::prior(
  p = 5,                                    # Number of parameters
  type = "univariate",                      # Prior type
  beta_mean = rep(0, 5),                   # Prior mean for coefficients
  beta_cov = diag(1000, 5),               # Prior covariance matrix
  sigma_shape = 0.001,                     # Shape parameter for sigma (ALD only)
  sigma_rate = 0.001,                      # Rate parameter for sigma (ALD only)
  names = c("Int", "x1", "x2", "x3", "x4") # Parameter names
)
print(my_prior)
```

## Fitting Models with Different Methods

```{r method-examples, eval=FALSE}
# Example data
data(mtcars)

# Method 1: ALD (Asymmetric Laplace Distribution)
fit_ald <- bqr.svy(
  mpg ~ wt + hp + cyl,
  data = mtcars,
  quantile = 0.5,
  method = "ald",
  niter = 10000,
  burnin = 5000,
  thin = 5,
  print_progress = 5000  # Print every 5000 iterations
)

# Method 2: Score Likelihood
fit_score <- bqr.svy(
  mpg ~ wt + hp + cyl,
  data = mtcars,
  quantile = 0.5,
  method = "score",
  niter = 10000,
  burnin = 5000,
  thin = 5,
  print_progress = 5000
)

# Method 3: Approximate Method
fit_approx <- bqr.svy(
  mpg ~ wt + hp + cyl,
  data = mtcars,
  quantile = 0.5,
  method = "approximate",
  niter = 10000,
  burnin = 5000,
  thin = 5,
  print_progress = 5000  # Print every 5000 iterations
)
```

## Model Output: Summary and Print Methods

```{r output-examples, eval=FALSE}
# Print method - shows basic model information
print(fit_ald)

# Summary method - detailed convergence diagnostics
summary(fit_ald)

# Extract coefficient estimates
coef_estimates <- fit_ald$beta
print(coef_estimates)

# Access posterior draws
posterior_draws <- fit_ald$draws
head(posterior_draws)

# Check acceptance rate (if available)
if (!is.null(fit_ald$accept_rate)) {
  cat("Acceptance rate:", fit_ald$accept_rate, "\n")
}
```

# Data Preparation

```{r data-prep}
library(tauBayesW)
library(bayesQR)

# Load Prostate dataset
data(Prostate, package = "bayesQR")

# Center covariates (subtract mean, don't scale)
covars <- Prostate[, colnames(Prostate) != "lpsa"]
covars_centered <- as.data.frame(scale(covars, center = TRUE, scale = FALSE))

# Combined dataset with centered covariates
Prostate_centered <- cbind(lpsa = Prostate$lpsa, covars_centered)

# Design matrix (includes intercept automatically)
X <- model.matrix(lpsa ~ ., data = Prostate_centered)
y <- Prostate_centered$lpsa
w <- rep(1, length(y))  # Equal weights

# Display dataset summary
cat("Dataset dimensions:", nrow(Prostate_centered), "observations,", ncol(X), "coefficients\n")
cat("Response variable: lpsa (log prostate-specific antigen)\n")
cat("Predictors:", paste(colnames(X), collapse = ", "), "\n")
```

# Prior Specification

We use comparable priors for fair comparison:

```{r priors}
# Prior for tauBayesW (all methods)
prior_tbw <- tauBayesW::prior(
  p = ncol(X),
  type = "univariate",
  beta_mean = rep(0, ncol(X)),
  beta_cov = diag(1e6, ncol(X)),  # Very vague prior
  sigma_shape = 0.001,            # For ALD method
  sigma_rate = 0.001,
  names = colnames(X)
)

# Prior for bayesQR 
prior_bqr <- bayesQR::prior(
  lpsa ~ ., data = Prostate_centered,
  beta0 = rep(0, ncol(X)), 
  V0 = diag(1e6, ncol(X))  # Same vague prior
)

print("Prior specifications:")
print(prior_tbw)
print(prior_bqr)
```

# Model Fitting

## bayesQR (Reference Method)

```{r bayesQR-fit}
cat("Fitting bayesQR model...\n")
set.seed(12345)

fit_bqr <- bayesQR(
  lpsa ~ ., 
  data = Prostate_centered,
  quantile = 0.75, 
  ndraw = 5000, 
  prior = prior_bqr, 
  keep = 5
)

# Extract coefficient estimates
draws_bqr <- fit_bqr[[1]][["betadraw"]]
colnames(draws_bqr) <- colnames(X)
coef_bqr <- colMeans(draws_bqr, na.rm = TRUE)

cat("bayesQR completed. Effective samples:", nrow(draws_bqr), "\n")
```

## tauBayesW Method 1: ALD (Asymmetric Laplace Distribution)

```{r tauBayesW-ald}
cat("Fitting tauBayesW ALD method...\n")
set.seed(12345)

fit_ald <- bqr.svy(
  lpsa ~ lcavol + lweight + age + lbph + svi + lcp + gleason + pgg45,
  data     = Prostate_centered,
  quantile = 0.75,
  method   = "ald",
  prior    = prior_tbw,
  niter    = 50000,
  burnin   = 25000,
  thin     = 5,
  print_progress = 25000
)

coef_ald <- fit_ald$beta
cat("ALD method completed.\n")
```

## tauBayesW Method 2: Score Likelihood

```{r tauBayesW-score}
cat("Fitting tauBayesW Score method...\n")
set.seed(12345)

fit_score <- bqr.svy(
  lpsa ~ lcavol + lweight + age + lbph + svi + lcp + gleason + pgg45,
  data     = Prostate_centered,
  quantile = 0.75,
  method   = "score",
  prior    = prior_tbw,
  niter    = 50000,
  burnin   = 25000,
  thin     = 5,
  print_progress = 25000
)

coef_score <- fit_score$beta
cat("Score method completed.\n")
```

## tauBayesW Method 3: Approximate Method

```{r tauBayesW-approximate}
cat("Fitting tauBayesW Approximate method...\n")
set.seed(12345)

fit_approximate <- bqr.svy(
  lpsa ~ lcavol + lweight + age + lbph + svi + lcp + gleason + pgg45,
  data     = Prostate_centered,
  quantile = 0.75,
  method   = "approximate",
  prior    = prior_tbw,
  niter    = 50000,
  burnin   = 25000,
  thin     = 5,
  print_progress = 25000
)

coef_approximate <- fit_approximate$beta
cat("Approximate method completed.\n")
```

```{r Comparison}
# Combine coefficient estimates into one table
results_table <- data.frame(
  Method       = c("bayesQR", "tauBayesW - ALD", "tauBayesW - Score", "tauBayesW - Approximate"),
  Intercept    = c(coef_bqr["(Intercept)"], 
                   coef_ald["(Intercept)"], 
                   coef_score["(Intercept)"], 
                   coef_approximate["(Intercept)"]),
  lcavol       = c(coef_bqr["lcavol"], 
                   coef_ald["lcavol"], 
                   coef_score["lcavol"], 
                   coef_approximate["lcavol"]),
  lweight      = c(coef_bqr["lweight"], 
                   coef_ald["lweight"], 
                   coef_score["lweight"], 
                   coef_approximate["lweight"]),
  age          = c(coef_bqr["age"], 
                   coef_ald["age"], 
                   coef_score["age"], 
                   coef_approximate["age"]),
  lbph         = c(coef_bqr["lbph"], 
                   coef_ald["lbph"], 
                   coef_score["lbph"], 
                   coef_approximate["lbph"]),
  svi          = c(coef_bqr["svi"], 
                   coef_ald["svi"], 
                   coef_score["svi"], 
                   coef_approximate["svi"]),
  lcp          = c(coef_bqr["lcp"], 
                   coef_ald["lcp"], 
                   coef_score["lcp"], 
                   coef_approximate["lcp"]),
  gleason      = c(coef_bqr["gleason"], 
                   coef_ald["gleason"], 
                   coef_score["gleason"], 
                   coef_approximate["gleason"]),
  pgg45        = c(coef_bqr["pgg45"], 
                   coef_ald["pgg45"], 
                   coef_score["pgg45"], 
                   coef_approximate["pgg45"])
)

# Nicely formatted table
knitr::kable(results_table, digits = 3, caption = "Coefficient Estimates at quantile 0.75")
```

# Model Summary and Print Methods

Let's examine the output from tauBayesW methods using `print()` and `summary()`:

## Print Methods

```{r print-methods}
cat("=== ALD Method ===\n")
print(fit_ald)

cat("\n=== Score Method ===\n")
print(fit_score)

cat("\n=== Approximate Method ===\n")
print(fit_approximate)
```

## Summary Methods (Detailed Diagnostics)

```{r summary-methods}
cat("=== ALD Method Summary ===\n")
summary(fit_ald)

cat("\n=== Score Method Summary ===\n")
summary(fit_score)

cat("\n=== Approximate Method Summary ===\n")
summary(fit_approximate)
```

## Convergence Diagnostics

```{r convergence-diagnostics}
# Check acceptance rates and other diagnostics
cat("Model Diagnostics Summary:\n")
cat("========================\n\n")

methods <- c("ALD", "Score", "Approximate")
fits <- list(fit_ald, fit_score, fit_approximate)

for (i in seq_along(methods)) {
  cat(sprintf("%s Method:\n", methods[i]))
  
  if (!is.null(fits[[i]]$accept_rate)) {
    cat(sprintf("  Acceptance rate: %.3f\n", fits[[i]]$accept_rate))
  }
  
  if (!is.null(fits[[i]]$draws)) {
    n_draws <- nrow(as.matrix(fits[[i]]$draws))
    cat(sprintf("  Posterior samples: %d\n", n_draws))
  }
  
  if (!is.null(fits[[i]]$final_scale)) {
    cat(sprintf("  Final MCMC scale: %.4f\n", fits[[i]]$final_scale))
  }
  
  cat("\n")
}
```
